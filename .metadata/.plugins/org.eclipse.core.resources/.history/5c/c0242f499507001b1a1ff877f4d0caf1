package io.marsab.minorproject.controller;



import java.util.Date;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.SessionAttributes;
import org.springframework.web.servlet.ModelAndView;

import io.marsab.minorproject.dao.UserRepository;
import io.marsab.minorproject.model.Post;
import io.marsab.minorproject.model.User;
import io.marsab.minorproject.service.PostServiceImpl;
import io.marsab.minorproject.service.UserServiceImpl;

@RestController
@RequestMapping("/user")
@SessionAttributes(names={"username","usermail"})
public class TestController {
	@Autowired
	private UserRepository userRepository;
	@Autowired
	private UserServiceImpl userServiceImpl;
	@Autowired
	private PostServiceImpl postServiceImpl;
	@RequestMapping("/")
	public String home() {	
		return "index";
	}
	
	@RequestMapping("/showsignup")
	public ModelAndView showSingUp() {
		ModelAndView modelAndView=new ModelAndView("signup");
		return modelAndView;
	}
	
	@RequestMapping("/signup")
	public String saveUser(@RequestParam("username") String name,@RequestParam("usermail") String email,@RequestParam("userpwd") String pwd) {
		User user=new User();
		user.setUsername(name);
		user.setEmail(email);
		user.setPassword(pwd);
		userServiceImpl.saveUser(user);
		return "success";
	}
	@RequestMapping("/showpost")
	public ModelAndView showPost() {
		ModelAndView modelAndView=new ModelAndView("post");
		return modelAndView;
	}
	
	@RequestMapping("/savepost")
	public ModelAndView savePost(@RequestParam("post_title") String title,@RequestParam("post_content")String content) {
		Post post=new Post();
		post.setTitle(title);
		post.setContent(content);
		post.setCreatedon(new Date());
		post.setUpdatedon(new Date());
		postServiceImpl.savePost(post);
		ModelAndView modelAndView=new ModelAndView("post");
		return modelAndView;
	}
	@RequestMapping("/posts")
	public ModelAndView showPosts() {
		ModelAndView modelAndView=new ModelAndView("allpost");
		//List<Post> posts=new ArrayList<Post>();
		List<Post> posts=postServiceImpl.showAllPost();
		modelAndView.addObject("allpost", posts);
		return modelAndView;	
	}
	@RequestMapping("/showlogin")
	public ModelAndView showLogin() {
		ModelAndView modelAndView=new ModelAndView("login");
		return modelAndView;
	}
	@RequestMapping("/login")
	public ModelAndView loginUser(@RequestParam("usermail") String usermail,@RequestParam("userpwd") String pwd) {
		User user=new User();
		user.setEmail(usermail);
		user.setPassword(pwd);
		User user_temp=userServiceImpl.getUser(user);
		ModelAndView modelAndView;
		if(user_temp==null) {
			modelAndView=new ModelAndView("error");
		}else {
			
			modelAndView=new ModelAndView("index");
			modelAndView.addObject("username",user.getUsername());
			modelAndView.addObject("usermail",user.getEmail());
		}
		return modelAndView;
	}
	
}
